<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>eSIBiS - Sistem Informasi Bimbingan Skripsi-FEBI UINSI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; }
    #wrapper { display: flex; }
    #sidebar { width: 250px; min-height: 100vh; transition: all 0.3s; background-color: #343a40; color: white; }
    .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid #495057; }
    .list-unstyled a { color: #dfe4ea; padding: 15px; text-decoration: none; display: flex; align-items: center; }
    .list-unstyled a:hover, .list-unstyled a.active { background-color: #495057; }
    .list-unstyled a i { width: 25px; }
    .content-section { display: none; padding: 20px; }
    .card { box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .similarity-check-container { margin-top: 15px; padding: 15px; border-radius: 5px; background-color: #f8f9fa; border: 1px solid #dee2e6; }
    .similarity-result { margin-top: 10px; padding: 10px; border-radius: 5px; }
    .similarity-high-bg { background-color: #ffeaea; border: 1px solid #f5c6cb; }
    .similarity-medium-bg { background-color: #fff3cd; border: 1px solid #ffeaa7; }
    .similarity-low-bg { background-color: #d4edda; border: 1px solid #c3e6cb; }
    .similarity-high { color: #c00; font-weight: bold; }
    .similarity-medium { color: #856404; font-weight: bold; }
    .similarity-low { color: #155724; font-weight: bold; }
    .email-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 1000; display: none; max-height: 200px; overflow-y: auto; }
    .email-suggestion { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    .email-suggestion:hover { background-color: #f8f9fa; }
  </style>
</head>
<body>
  <!-- Notification Toast -->
  <div class="notification-toast toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
    <div class="toast-header">
      <strong class="me-auto">SIBiS Notification</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">Notifikasi akan muncul di sini.</div>
  </div>

  <!-- Modal: Hasil Similarity -->
  <div class="modal fade" id="similarityModal" tabindex="-1" aria-labelledby="similarityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="similarityModalLabel">Hasil Pengecekan Similarity</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Sistem telah menganalisis judul proposal Anda dan membandingkannya dengan database skripsi yang ada.
          </div>
          <div class="similarity-result" id="similarityResult"></div>
          <div class="mt-3">
            <h6>Judul-judul yang mirip:</h6>
            <div id="similarTitlesList" class="mt-2"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          <button type="button" class="btn btn-primary" id="proceedAnywayBtn">Lanjutkan Saja</button>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="bg-dark" id="sidebar">
      <div class="sidebar-header">
        <h3 class="m-0">eSIBiS</h3>
      </div>
      <ul class="list-unstyled">
        <li>
          <a href="#bimbinganSubmenu" data-bs-toggle="collapse" class="dropdown-toggle active">
            <i class="fas fa-graduation-cap"></i><span>Bimbingan</span>
          </a>
          <ul class="sub-menu show collapse list-unstyled" id="bimbinganSubmenu">
            <li><a href="#pengajuan" class="sub-item active"><i class="fas fa-file-upload"></i><span>Pengajuan Proposal</span></a></li>
            <li><a href="#dataBimbingan" class="sub-item"><i class="fas fa-database"></i><span>Data Bimbingan</span></a></li>
            <li><a href="#tahapBimbingan" class="sub-item"><i class="fas fa-tasks"></i><span>Tahap Bimbingan</span></a></li>
            <li><a href="#statusBimbingan" class="sub-item"><i class="fas fa-chart-line"></i><span>Status Bimbingan</span></a></li>
          </ul>
        </li>
        <li><a href="#skripsiSubmenu" data-bs-toggle="collapse" class="dropdown-toggle"><i class="fas fa-book"></i><span>Skripsi</span></a>
          <ul class="sub-menu collapse list-unstyled" id="skripsiSubmenu">
            <li><a href="#uploadSkripsi" class="sub-item"><i class="fas fa-upload"></i><span>Upload Skripsi Final</span></a></li>
            <li><a href="#databaseSkripsi" class="sub-item"><i class="fas fa-database"></i><span>Database Skripsi</span></a></li>
          </ul>
        </li>
        <li><a href="#statistik" class="main-item"><i class="fas fa-chart-bar"></i><span>Statistik</span></a></li>
      </ul>
    </div>

    <!-- Page Content -->
    <div id="page-content-wrapper">
      <div class="container-fluid">
        <!-- Bimbingan Section -->
        <div id="bimbinganContent">
          <!-- Pengajuan Proposal -->
          <div class="content-section" id="pengajuan">
            <div class="card">
              <div class="card-header">
                <h5 class="card-title mb-0">Pengajuan Proposal Skripsi</h5>
              </div>
              <div class="card-body">
                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i> Pastikan proposal telah melalui konsultasi dengan calon pembimbing sebelum diajukan.
                </div>
                <form id="pengajuanProposalForm">
                  <div class="mb-3">
                    <label for="nimProposal" class="form-label">NIM</label>
                    <input type="text" class="form-control" id="nimProposal" required>
                  </div>
                  <div class="mb-3">
                    <label for="namaProposal" class="form-label">Nama</label>
                    <input type="text" class="form-control" id="namaProposal" required>
                  </div>
                  <div class="mb-3">
                    <label for="prodiProposal" class="form-label">Program Studi</label>
                    <select class="form-select" id="prodiProposal" required>
                      <option value="">Pilih Program Studi</option>
                      <option value="TI">Teknik Informatika</option>
                      <option value="SI">Sistem Informasi</option>
                      <option value="DKV">Desain Komunikasi Visual</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="tahunAkademik" class="form-label">Tahun Akademik</label>
                    <select class="form-select" id="tahunAkademik" required>
                      <option value="">Pilih Tahun</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="judulProposal" class="form-label">Judul Proposal</label>
                    <input type="text" class="form-control" id="judulProposal" required>
                    <div class="form-text">Gunakan format yang jelas dan sesuai dengan kaidah penulisan ilmiah</div>
                  </div>
                  <!-- Similarity Check Section -->
                  <div class="similarity-check-container">
                    <div class="d-flex justify-content-between align-items-center">
                      <h6 class="mb-0">Pengecekan Similarity Judul</h6>
                      <button type="button" class="btn btn-sm btn-outline-primary" id="checkSimilarityBtn">
                        <i class="fas fa-search"></i> Cek Similarity
                      </button>
                    </div>
                    <div id="similarityCheckResult" class="mt-2">
                      <!-- Hasil pengecekan similarity akan ditampilkan di sini -->
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="dosenPembimbing1" class="form-label">Dosen Pembimbing 1</label>
                    <select class="form-select" id="dosenPembimbing1" required>
                      <option value="">Pilih Dosen Pembimbing 1</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="dosenPembimbing2" class="form-label">Dosen Pembimbing 2 (opsional)</label>
                    <select class="form-select" id="dosenPembimbing2">
                      <option value="">Pilih Dosen Pembimbing 2 (jika diperlukan)</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="fileProposal" class="form-label">Upload Proposal</label>
                    <input type="file" class="form-control" id="fileProposal" accept=".pdf,.doc,.docx" required>
                    <div class="form-text">Format file: PDF atau DOC/DOCX (maks. 10MB)</div>
                  </div>
                  <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Ajukan Proposal</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbxM2R5pekHkL66CSEGK7RzVATZUKHW3LH_BflLzR6IHOSirqN87w_zSd4RzviCEcNLyZg/exec';
    let currentSection = 'pengajuan';
    let currentMenu = 'bimbingan';

    $(document).ready(function () {
      initTahunAkademik();
      initDosenOptions();
      $('.content-section').hide();
      $('#pengajuan').show();

      // Cek Similarity
      $('#checkSimilarityBtn').click(function () {
        const judul = $('#judulProposal').val().trim();
        if (!judul) {
          showNotification('Masukkan judul proposal terlebih dahulu', 'warning');
          return;
        }

        $(this).html('<span class="spinner-border spinner-border-sm" role="status"></span> Mengecek...');
        $(this).prop('disabled', true);

        $.ajax({
          url: scriptUrl,
          method: 'POST',
          data: {
            action: 'checkSimilarity',
            judul: judul
          },
          success: function (response) {
            try {
              const data = typeof response === 'string' ? JSON.parse(response) : response;
              if (data.result === 'success') {
                displaySimilarityResult(data.similarity, data.similarTitles);
              } else {
                showNotification('Gagal memeriksa similarity: ' + data.message, 'error');
              }
            } catch (e) {
              showNotification('Respons tidak valid dari server.', 'error');
            }
          },
          error: function () {
            showNotification('Terjadi kesalahan saat memeriksa similarity.', 'error');
          },
          complete: function () {
            $('#checkSimilarityBtn').html('<i class="fas fa-search"></i> Cek Similarity');
            $('#checkSimilarityBtn').prop('disabled', false);
          }
        });
      });

      // Form submission
      $('#pengajuanProposalForm').submit(function (e) {
        e.preventDefault();
        const judul = $('#judulProposal').val().trim();
        if (!judul) {
          showNotification('Judul proposal harus diisi.', 'warning');
          return;
        }

        // Cek similarity sebelum submit
        $.ajax({
          url: scriptUrl,
          method: 'POST',
          async: false,
          data: { action: 'checkSimilarity', judul: judul },
          success: function (res) {
            const data = JSON.parse(res);
            if (data.result === 'success' && data.similarity >= 70) {
              $('#similarityModal').modal('show');
              return false;
            } else {
              submitProposal();
            }
          },
          error: function () {
            submitProposal();
          }
        });
      });

      $('#proceedAnywayBtn').click(function () {
        $('#similarityModal').modal('hide');
        submitProposal();
      });
    });

    function submitProposal() {
      const form = $('#pengajuanProposalForm')[0];
      const formData = new FormData(form);
      formData.append('action', 'uploadProposal');

      const file = $('#fileProposal')[0].files[0];
      if (file.size > 10 * 1024 * 1024) {
        showNotification('Ukuran file maksimal 10MB.', 'warning');
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const base64 = e.target.result.split(',')[1];
        formData.append('file', base64);
        formData.append('filename', file.name);
        formData.append('mimeType', file.type);

        const submitBtn = $('button[type="submit"]');
        submitBtn.html('<span class="spinner-border spinner-border-sm"></span> Mengajukan...').prop('disabled', true);

        fetch(scriptUrl, { method: 'POST', body: formData })
          .then(res => res.json())
          .then(data => {
            if (data.result === 'success') {
              showNotification('Proposal berhasil diajukan!', 'success');
              $('#pengajuanProposalForm')[0].reset();
            } else {
              showNotification('Gagal: ' + data.message, 'error');
            }
          })
          .catch(err => {
            showNotification('Kesalahan jaringan.', 'error');
          })
          .finally(() => {
            submitBtn.html('<i class="fas fa-paper-plane"></i> Ajukan Proposal').prop('disabled', false);
          });
      };
      reader.readAsDataURL(file);
    }

    function displaySimilarityResult(similarity, similarTitles) {
      let simClass, simBg, simText, recommendation;

      if (similarity >= 70) {
        simClass = 'similarity-high'; simBg = 'similarity-high-bg'; simText = 'Tinggi'; recommendation = 'TOLAK - Judul terlalu mirip.';
      } else if (similarity >= 40) {
        simClass = 'similarity-medium'; simBg = 'similarity-medium-bg'; simText = 'Sedang'; recommendation = 'PERLU DIPERBAIKI.';
      } else {
        simClass = 'similarity-low'; simBg = 'similarity-low-bg'; simText = 'Rendah'; recommendation = 'DITERIMA.';
      }

      $('#similarityCheckResult').html(`
        <div class="similarity-result ${simBg}">
          <p class="mb-1">Tingkat Similarity: <span class="${simClass}">${similarity.toFixed(2)}% (${simText})</span></p>
          <p class="mb-0 small"><strong>Rekomendasi:</strong> ${recommendation}</p>
        </div>
      `);

      if (similarity >= 40) {
        let listHtml = '';
        if (similarTitles && similarTitles.length > 0) {
          similarTitles.forEach(t => {
            listHtml += `<div class="mb-2 p-2 border rounded">
              <div class="fw-bold">${t.Judul}</div>
              <div class="small">Oleh: ${t.Penulis} (${t.Tahun}) | Similarity: ${t.Similarity.toFixed(2)}%</div>
            </div>`;
          });
        } else {
          listHtml = '<p>Tidak ditemukan judul mirip.</p>';
        }
        $('#similarTitlesList').html(listHtml);
        $('#similarityModal').modal('show');
      }
    }

    function showNotification(message, type = 'info') {
      const toastEl = $('.notification-toast');
      const header = toastEl.find('.toast-header');
      header.removeClass('bg-success bg-danger bg-warning').addClass(type === 'success' ? 'bg-success text-white' : type === 'error' ? 'bg-danger text-white' : 'bg-warning text-dark');
      $('.toast-body').text(message);
      const toast = new bootstrap.Toast(toastEl);
      toast.show();
    }

    function initTahunAkademik() {
      const currentYear = new Date().getFullYear();
      for (let i = currentYear - 5; i <= currentYear + 1; i++) {
        $('#tahunAkademik').append(`<option value="${i}/${i+1}">${i}/${i+1}</option>`);
      }
    }

    function initDosenOptions() {
      const dosen = ['Dr. Ahmad, M.Kom', 'Prof. Budi, Ph.D', 'Dr. Cinta, M.Sc'];
      dosen.forEach(d => {
        $('#dosenPembimbing1').append(`<option value="${d}">${d}</option>`);
        $('#dosenPembimbing2').append(`<option value="${d}">${d}</option>`);
      });
    }
  </script>
</body>
</html>
