<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Skripsi & Bimbingan</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }
        
        #sidebar {
            height: 100vh;
            background-color: var(--secondary-color);
            color: white;
            position: fixed;
            width: 250px;
            transition: all 0.3s;
            z-index: 1000;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        #sidebar .sidebar-header {
            padding: 20px;
            background-color: var(--primary-color);
        }
        
        #sidebar ul li a {
            padding: 15px 25px;
            display: block;
            color: #ddd;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        
        #sidebar ul li a:hover,
        #sidebar ul li a.active {
            background-color: #34495e;
            color: white;
            border-left: 4px solid var(--primary-color);
        }
        
        #sidebar ul li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        #content {
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0 !important;
        }
        
        .tab-content {
            padding: 20px;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            color: white;
        }
        
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .stat-card h2 {
            font-size: 2rem;
            margin: 0;
        }
        
        .stat-card p {
            margin: 5px 0 0;
            font-size: 0.9rem;
        }
        
        .bg-primary { background: linear-gradient(45deg, #3498db, #2980b9); }
        .bg-success { background: linear-gradient(45deg, #2ecc71, #27ae60); }
        .bg-warning { background: linear-gradient(45deg, #f39c12, #e67e22); }
        .bg-danger { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        
        .nav-tabs .nav-link {
            border: none;
            border-bottom: 3px solid transparent;
            color: #555;
            font-weight: 500;
            padding: 10px 15px;
        }
        
        .nav-tabs .nav-link.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
        }
        
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }
        
        table {
            width: 100%;
        }
        
        table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .similarity-high {
            color: var(--accent-color);
            font-weight: bold;
        }
        
        .similarity-medium {
            color: var(--warning-color);
            font-weight: bold;
        }
        
        .similarity-low {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .warning-item {
            border-left: 4px solid var(--accent-color);
            padding-left: 15px;
            margin-bottom: 15px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            #sidebar {
                margin-left: -250px;
            }
            #sidebar.active {
                margin-left: 0;
            }
            #content {
                margin-left: 0;
            }
            #content.active {
                margin-left: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3>Dashboard Skripsi</h3>
        </div>

        <ul class="list-unstyled components">
            <li>
                <a href="#bimbinganMenu" data-bs-toggle="collapse" aria-expanded="false" class="dropdown-toggle active">
                    <i class="fas fa-graduation-cap"></i> Bimbingan
                </a>
                <ul class="collapse list-unstyled" id="bimbinganMenu">
                    <li><a href="#pengajuan" class="submenu-item active" data-tab="pengajuan">Pengajuan Proposal</a></li>
                    <li><a href="#dataBimbingan" class="submenu-item" data-tab="dataBimbingan">Data Bimbingan</a></li>
                    <li><a href="#tahapBimbingan" class="submenu-item" data-tab="tahapBimbingan">Tahap Bimbingan</a></li>
                    <li><a href="#statusBimbingan" class="submenu-item" data-tab="statusBimbingan">Status Bimbingan</a></li>
                    <li><a href="#earlyWarning" class="submenu-item" data-tab="earlyWarning">Early Warning</a></li>
                </ul>
            </li>
            <li>
                <a href="#skripsiMenu" data-bs-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                    <i class="fas fa-book"></i> Skripsi
                </a>
                <ul class="collapse list-unstyled" id="skripsiMenu">
                    <li><a href="#databaseSkripsi" class="submenu-item" data-tab="databaseSkripsi">Database Skripsi</a></li>
                    <li><a href="#uploadSkripsi" class="submenu-item" data-tab="uploadSkripsi">Upload Skripsi Final</a></li>
                </ul>
            </li>
        </ul>
    </nav>

    <!-- Content -->
    <div id="content">
        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Pengajuan Proposal -->
            <div class="tab-pane fade show active" id="pengajuan">
                <div class="card">
                    <div class="card-header">
                        <h5>Pengajuan Proposal Skripsi</h5>
                    </div>
                    <div class="card-body">
                        <form id="proposalForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="nama" class="form-label">Nama Mahasiswa</label>
                                    <input type="text" class="form-control" id="nama" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="nim" class="form-label">NIM</label>
                                    <input type="text" class="form-control" id="nim" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="prodi" class="form-label">Program Studi</label>
                                    <select class="form-select" id="prodi" required>
                                        <option value="">Pilih Program Studi</option>
                                        <option value="Ekonomi Syariah">Ekonomi Syariah</option>
                                        <option value="Perbankan Syariah">Perbankan Syariah</option>
                                        <option value="Manajemen Bisnis Syariah">Manajemen Bisnis Syariah</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="dosen" class="form-label">Dosen Pembimbing</label>
                                    <select class="form-select" id="dosen" required>
                                        <option value="">Pilih Dosen Pembimbing</option>
                                        <!-- Options akan diisi melalui JavaScript -->
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="judul" class="form-label">Judul Proposal</label>
                                <textarea class="form-control" id="judul" rows="3" required></textarea>
                                <div class="form-text">Setelah mengisi judul, sistem akan mengecek similarity dengan judul yang sudah ada.</div>
                            </div>
                            <div class="alert alert-info" id="similarityResult" style="display: none;">
                                <i class="fas fa-info-circle"></i> <span id="similarityText"></span>
                            </div>
                            <button type="submit" class="btn btn-primary">Ajukan Proposal</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Data Bimbingan -->
            <div class="tab-pane fade" id="dataBimbingan">
                <div class="card">
                    <div class="card-header">
                        <h5>Data Bimbingan Skripsi</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="tabelBimbingan">
                                <thead>
                                    <tr>
                                        <th>NIM</th>
                                        <th>Nama Mahasiswa</th>
                                        <th>Dosen Pembimbing</th>
                                        <th>Judul Skripsi</th>
                                        <th>Tanggal Pengajuan</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data akan diisi melalui JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tahap Bimbingan -->
            <div class="tab-pane fade" id="tahapBimbingan">
                <div class="card">
                    <div class="card-header">
                        <h5>Tahap Bimbingan Skripsi</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="tabelTahapBimbingan">
                                <thead>
                                    <tr>
                                        <th>NIM</th>
                                        <th>Nama Mahasiswa</th>
                                        <th>Tahap</th>
                                        <th>Tanggal Bimbingan</th>
                                        <th>Keterangan</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data akan diisi melalui JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Bimbingan -->
            <div class="tab-pane fade" id="statusBimbingan">
                <div class="card">
                    <div class="card-header">
                        <h5>Status Bimbingan Skripsi</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stat-card bg-primary">
                                    <i class="fas fa-user-graduate"></i>
                                    <h2 id="totalMahasiswa">0</h2>
                                    <p>Total Mahasiswa</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card bg-success">
                                    <i class="fas fa-check-circle"></i>
                                    <h2 id="selesaiBimbingan">0</h2>
                                    <p>Selesai Bimbingan</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card bg-warning">
                                    <i class="fas fa-spinner"></i>
                                    <h2 id="prosesBimbingan">0</h2>
                                    <p>Dalam Proses</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card bg-danger">
                                    <i class="fas fa-times-circle"></i>
                                    <h2 id="tertundaBimbingan">0</h2>
                                    <p>Tertunda</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="tabelStatusBimbingan">
                                <thead>
                                    <tr>
                                        <th>NIM</th>
                                        <th>Nama Mahasiswa</th>
                                        <th>Dosen Pembimbing</th>
                                        <th>Progress</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data akan diisi melalui JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Early Warning -->
            <div class="tab-pane fade" id="earlyWarning">
                <div class="card">
                    <div class="card-header">
                        <h5>Early Warning System</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Sistem ini memberikan peringatan dini kepada mahasiswa semester 10-14 yang belum menyelesaikan skripsi.
                        </div>
                        
                        <div id="warningList">
                            <!-- Data peringatan akan diisi melalui JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Skripsi -->
            <div class="tab-pane fade" id="databaseSkripsi">
                <div class="card">
                    <div class="card-header">
                        <h5>Database Skripsi</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="filterTahun" class="form-label">Tahun Lulus</label>
                                <select class="form-select" id="filterTahun">
                                    <option value="">Semua Tahun</option>
                                    <!-- Options akan diisi melalui JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filterProdi" class="form-label">Program Studi</label>
                                <select class="form-select" id="filterProdi">
                                    <option value="">Semua Program Studi</option>
                                    <option value="Ekonomi Syariah">Ekonomi Syariah</option>
                                    <option value="Perbankan Syariah">Perbankan Syariah</option>
                                    <option value="Manajemen Bisnis Syariah">Manajemen Bisnis Syariah</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filterStatus" class="form-label">Status</label>
                                <select class="form-select" id="filterStatus">
                                    <option value="">Semua Status</option>
                                    <option value="Lulus">Lulus</option>
                                    <option value="Dalam Proses">Dalam Proses</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="pencarian" class="form-label">Pencarian</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="pencarian" placeholder="Cari judul skripsi...">
                                    <button class="btn btn-outline-secondary" type="button" id="btnCari">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="tabelSkripsi">
                                <thead>
                                    <tr>
                                        <th>Judul Skripsi</th>
                                        <th>Penulis</th>
                                        <th>Program Studi</th>
                                        <th>Tahun</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data akan diisi melalui JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Skripsi Final -->
            <div class="tab-pane fade" id="uploadSkripsi">
                <div class="card">
                    <div class="card-header">
                        <h5>Upload Skripsi Final</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="uploadNim" class="form-label">NIM</label>
                                    <input type="text" class="form-control" id="uploadNim" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="uploadNama" class="form-label">Nama Mahasiswa</label>
                                    <input type="text" class="form-control" id="uploadNama" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="uploadJudul" class="form-label">Judul Skripsi</label>
                                    <textarea class="form-control" id="uploadJudul" rows="2" required></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label for="uploadProdi" class="form-label">Program Studi</label>
                                    <select class="form-select" id="uploadProdi" required>
                                        <option value="">Pilih Program Studi</option>
                                        <option value="Ekonomi Syariah">Ekonomi Syariah</option>
                                        <option value="Perbankan Syariah">Perbankan Syariah</option>
                                        <option value="Manajemen Bisnis Syariah">Manajemen Bisnis Syariah</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="uploadFile" class="form-label">File Skripsi (PDF)</label>
                                <input class="form-control" type="file" id="uploadFile" accept=".pdf" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload Skripsi</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visualisasi Data -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Statistik Bimbingan per Program Studi</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="prodiChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Status Penyelesaian Skripsi</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // URL Google Apps Script Web App
        const WEB_APP_URL = 'https://script.google.com/macros/s/1DkWgjb6jVQ96cSd6oP9k00vo9NYiWwGt7ZI8CGcMm0/exec';
        
        // Data global untuk chart
        let prodiChart, statusChart;
        
        $(document).ready(function() {
            // Inisialisasi tab
            $('.submenu-item').on('click', function(e) {
                e.preventDefault();
                const tabId = $(this).data('tab');
                
                // Toggle active class
                $('.submenu-item').removeClass('active');
                $(this).addClass('active');
                
                // Tampilkan tab yang sesuai
                $('.tab-pane').removeClass('show active');
                $(`#${tabId}`).addClass('show active');
                
                // Muat data sesuai tab
                loadTabData(tabId);
            });
            
            // Event listener untuk form pengajuan proposal
            $('#proposalForm').on('submit', function(e) {
                e.preventDefault();
                ajukanProposal();
            });
            
            // Event listener untuk form upload skripsi
            $('#uploadForm').on('submit', function(e) {
                e.preventDefault();
                uploadSkripsi();
            });
            
            // Event listener untuk pencarian di database skripsi
            $('#btnCari').on('click', function() {
                filterSkripsi();
            });
            
            $('#pencarian, #filterTahun, #filterProdi, #filterStatus').on('change keyup', function() {
                filterSkripsi();
            });
            
            // Event listener untuk pengecekan similarity
            $('#judul').on('blur', function() {
                cekSimilarity($(this).val());
            });
            
            // Muat data awal
            loadDosenOptions();
            loadTabData('pengajuan');
            loadVisualisasiData();
        });
        
        // Fungsi untuk memuat data sesuai tab yang aktif
        function loadTabData(tabId) {
            switch(tabId) {
                case 'pengajuan':
                    // Tidak perlu load data tambahan
                    break;
                case 'dataBimbingan':
                    loadDataBimbingan();
                    break;
                case 'tahapBimbingan':
                    loadTahapBimbingan();
                    break;
                case 'statusBimbingan':
                    loadStatusBimbingan();
                    break;
                case 'earlyWarning':
                    loadEarlyWarning();
                    break;
                case 'databaseSkripsi':
                    loadDatabaseSkripsi();
                    break;
                case 'uploadSkripsi':
                    // Tidak perlu load data tambahan
                    break;
            }
        }
        
        // Fungsi untuk memuat opsi dosen dari Google Sheets
        function loadDosenOptions() {
            $.ajax({
                url: WEB_APP_URL,
                method: 'GET',
                dataType: 'json',
                data: { action: 'getDosen' },
                success: function(response) {
                    if (response && response.length > 0) {
                        $('#dosen').empty().append('<option value="">Pilih Dosen Pembimbing</option>');
                        response.forEach(function(dosen) {
                            $('#dosen').append(`<option value="${dosen.nama}">${dosen.nama}</option>`);
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading dosen options:', error);
                }
            });
        }
        
        // Fungsi untuk memuat data bimbingan
        function loadDataBimbingan() {
            $.ajax({
                url: WEB_APP_URL,
                method: 'GET',
                dataType: 'json',
                data: { action: 'getBimbingan' },
                success: function(response) {
                    if (response && response.length > 0) {
                        const tbody = $('#tabelBimbingan tbody');
                        tbody.empty();
                        
                        response.forEach(function(item) {
                            const row = `
                                <tr>
                                    <td>${item.nim || ''}</td>
                                    <td>${item.nama || ''}</td>
                                    <td>${item.dosen || ''}</td>
                                    <td>${item.judul || ''}</td>
                                    <td>${item.tanggal || ''}</td>
                                    <td><span class="badge bg-${getStatusBadgeColor(item.status)}">${item.status || ''}</span></td>
                                </tr>
                            `;
                            tbody.append(row);
                        });
                    } else {
                        $('#tabelBimbingan tbody').html('<tr><td colspan="6" class="text-center">Tidak ada data bimbingan</td></tr>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading bimbingan data:', error);
                    $('#tabelBimbingan tbody').html('<tr><td colspan="6" class="text-center">Error memuat data</td></tr>');
                }
            });
        }
        
        // Fungsi untuk memuat tahap bimbingan
        function loadTahapBimbingan() {
            $.ajax({
                url: WEB_APP_URL,
                method: 'GET',
                dataType: 'json',
                data: { action: 'getBimbingan' },
                success: function(response) {
                    if (response && response.length > 0) {
                        const tbody = $('#tabelTahapBimbingan tbody');
                        tbody.empty();
                        
                        response.forEach(function(item) {
                            const tahap = item.tahap || 'Belum dimulai';
                            const tanggal = item.tanggal_bimbingan || '-';
                            const keterangan = item.keterangan || '-';
                            
                            const row = `
                                <tr>
                                    <td>${item.nim || ''}</td>
                                    <td>${item.nama || ''}</td>
                                    <td>${tahap}</td>
                                    <td>${tanggal}</td>
                                    <td>${keterangan}</td>
                                    <td><span class="badge bg-${getStatusBadgeColor(item.status)}">${item.status || ''}</span></td>
                                </tr>
                            `;
                            tbody.append(row);
                        });
                    } else {
                        $('#tabelTahapBimbingan tbody').html('<tr><td colspan="6" class="text-center">Tidak ada data tahap bimbingan</td></tr>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading tahap bimbingan data:', error);
                    $('#tabelTahapBimbingan tbody').html('<tr><td colspan="6" class="text-center">Error memuat data</td></tr>');
                }
            });
        }
        
        // Fungsi untuk memuat status bimbingan
        function loadStatusBimbingan() {
            $.ajax({
                url: WEB_APP_URL,
                method: 'GET',
                dataType: 'json',
                data: { action: 'getBimbingan' },
                success: function(response) {
                    if (response && response.length > 0) {
                        const tbody = $('#tabelStatusBimbingan tbody');
                        tbody.empty();
                        
                        let total = 0, selesai = 0, proses = 0, tertunda = 0;
                        
                        response.forEach(function(item) {
                            total++;
                            
                            if (item.status === 'Selesai') selesai++;
                            else if (item.status === 'Dalam Proses') proses++;
                            else tertunda++;
                            
                            const progress = item.progress || '0%';
                            
                            const row = `
                                <tr>
                                    <td>${item.nim || ''}</td>
                                    <td>${item.nama || ''}</td>
                                    <td>${item.dosen || ''}</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" style="width: ${progress}" aria-valuenow="${progress.replace('%', '')}" aria-valuemin="0" aria-valuemax="100">${progress}</div>
                                        </div>
                                    </td>
                                    <td><span class="badge bg-${getStatusBadgeColor(item.status)}">${item.status || ''}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary">Detail</button>
                                    </td>
                                </tr>
                            `;
                            tbody.append(row);
                        });
                        
                        // Update statistik
                        $('#totalMahasiswa').text(total);
                        $('#selesaiBimbingan').text(selesai);
                        $('#prosesBimbingan').text(proses);
                        $('#tertundaBimbingan').text(tertunda);
                    } else {
                        $('#tabelStatusBimbingan tbody').html('<tr><td colspan="6" class="text-center">Tidak ada data status bimbingan</td></tr>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading status bimbingan data:', error);
                    $('#tabelStatusBimbingan tbody').html('<tr><td colspan="6" class="text-center">Error memuat data</td></tr>');
                }
            });
        }
        
        // Fungsi untuk memuat early warning
        function loadEarlyWarning() {
            $.ajax({
                url: WEB_APP_URL,
                method: 'GET',
                dataType: 'json',
                data: { action: 'getEarlyWarning' },
                success: function(response) {
                    const warningList = $('#warningList');
                    warningList.empty();
                    
                    if (response && response.length > 0) {
                        response.forEach(function(item) {
                            const warningItem = `
                                <div class="warning-item">
                                    <h5>${item.nama} (NIM: ${item.nim})</h5>
                                    <p><strong>Program Studi:</strong> ${item.prodi}</p>
                                    <p><strong>Semester:</strong> ${item.semester}</p>
                                    <p><strong>Status:</strong> <span class="badge bg-danger">${item.status}</span></p>
                                    <p><strong>Keterangan:</strong> ${item.keterangan}</p>
                                </div>
                            `;
                            warningList.append(warningItem);
                        });
                    } else {
                        warningList.html('<div class="alert alert-success"><i class="fas fa-check-circle"></i> Tidak ada mahasiswa yang memerlukan peringatan dini.</div>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading early warning data:', error);
                    $('#warningList').html('<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error memuat data peringatan dini.</div>');
                }
            });
        }
        
        // Fungsi untuk memuat database skripsi
        function loadDatabaseSkripsi() {
            $.ajax({
                url: WEB_APP_URL,
                method: 'GET',
                dataType: 'json',
                data: { action: 'getSkripsi' },
                success: function(response) {
                    if (response && response.length > 0) {
                        window.skripsiData = response; // Simpan data untuk filtering
                        
                        // Isi opsi tahun
                        const tahunSet = new Set();
                        response.forEach(item => {
                            if (item.tahun) tahunSet.add(item.tahun);
                        });
                        
                        $('#filterTahun').empty().append('<option value="">Semua Tahun</option>');
                        Array.from(tahunSet).sort().reverse().forEach(tahun => {
                            $('#filterTahun').append(`<option value="${tahun}">${tahun}</option>`);
                        });
                        
                        renderSkripsiTable(response);
                    } else {
                        $('#tabelSkripsi tbody').html('<tr><td colspan="6" class="text-center">Tidak ada data skripsi</td></tr>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading skripsi data:', error);
                    $('#tabelSkripsi tbody').html('<tr><td colspan="6" class="text-center">Error memuat data</td></tr>');
                }
            });
        }
        
        // Fungsi untuk render tabel skripsi
        function renderSkripsiTable(data) {
            const tbody = $('#tabelSkripsi tbody');
            tbody.empty();
            
            if (data && data.length > 0) {
                data.forEach(function(item) {
                    const row = `
                        <tr>
                            <td>${item.judul || ''}</td>
                            <td>${item.penulis || ''}</td>
                            <td>${item.prodi || ''}</td>
                            <td>${item.tahun || ''}</td>
                            <td><span class="badge bg-${item.status === 'Lulus' ? 'success' : 'warning'}">${item.status || ''}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary">Detail</button>
                                ${item.status === 'Lulus' ? `<button class="btn btn-sm btn-outline-success">Download</button>` : ''}
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            } else {
                tbody.html('<tr><td colspan="6" class="text-center">Tidak ada data skripsi</td></tr>');
            }
        }
        
        // Fungsi untuk filter skripsi
        function filterSkripsi() {
            if (!window.skripsiData) return;
            
            const tahun = $('#filterTahun').val();
            const prodi = $('#filterProdi').val();
            const status = $('#filterStatus').val();
            const pencarian = $('#pencarian').val().toLowerCase();
            
            const filteredData = window.skripsiData.filter(item => {
                return (!tahun || item.tahun == tahun) &&
                       (!prodi || item.prodi === prodi) &&
                       (!status || item.status === status) &&
                       (!pencarian || (item.judul && item.judul.toLowerCase().includes(pencarian)));
            });
            
            renderSkripsiTable(filteredData);
        }
        
        // Fungsi untuk cek similarity judul
        function cekSimilarity(judul) {
            if (!judul || judul.length < 10) {
                $('#similarityResult').hide();
                return;
            }
            
            $.ajax({
                url: WEB_APP_URL,
                method: 'GET',
                dataType: 'json',
                data: { 
                    action: 'checkSimilarity',
                    judul: judul
                },
                success: function(response) {
                    if (response && response.similarity !== undefined) {
                        const similarity = response.similarity;
                        let message = '';
                        let alertClass = 'alert-info';
                        
                        if (similarity > 0.7) {
                            message = `Tingkat similarity tinggi (${Math.round(similarity * 100)}%). Judul sangat mirip dengan judul yang sudah ada.`;
                            alertClass = 'alert-danger';
                        } else if (similarity > 0.4) {
                            message = `Tingkat similarity sedang (${Math.round(similarity * 100)}%). Judul cukup mirip dengan judul yang sudah ada.`;
                            alertClass = 'alert-warning';
                        } else {
                            message = `Tingkat similarity rendah (${Math.round(similarity * 100)}%). Judul dapat diajukan.`;
                            alertClass = 'alert-success';
                        }
                        
                        $('#similarityText').html(message);
                        $('#similarityResult').removeClass('alert-info alert-danger alert-warning alert-success').addClass(alertClass).show();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error checking similarity:', error);
                }
            });
        }
        
        // Fungsi untuk ajukan proposal
        function ajukanProposal() {
            const formData = {
                nama: $('#nama').val(),
                nim: $('#nim').val(),
                prodi: $('#prodi').val(),
                dosen: $('#dosen').val(),
                judul: $('#judul').val()
            };
            
            // Validasi sederhana
            if (!formData.nama || !formData.nim || !formData.prodi || !formData.dosen || !formData.judul) {
                alert('Harap isi semua field yang wajib diisi.');
                return;
            }
            
            $.ajax({
                url: WEB_APP_URL,
                method: 'POST',
                dataType: 'json',
                data: {
                    action: 'submitProposal',
                    ...formData
                },
                success: function(response) {
                    if (response.success) {
                        alert('Proposal berhasil diajukan!');
                        $('#proposalForm')[0].reset();
                        $('#similarityResult').hide();
                    } else {
                        alert('Gagal mengajukan proposal: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error mengajukan proposal: ' + error);
                }
            });
        }
        
        // Fungsi untuk upload skripsi
        function uploadSkripsi() {
            const formData = new FormData();
            formData.append('action', 'uploadSkripsi');
            formData.append('nim', $('#uploadNim').val());
            formData.append('nama', $('#uploadNama').val());
            formData.append('judul', $('#uploadJudul').val());
            formData.append('prodi', $('#uploadProdi').val());
            formData.append('file', $('#uploadFile')[0].files[0]);
            
            // Validasi sederhana
            if (!formData.get('nim') || !formData.get('nama') || !formData.get('judul') || !formData.get('prodi') || !formData.get('file')) {
                alert('Harap isi semua field yang wajib diisi.');
                return;
            }
            
            $.ajax({
                url: WEB_APP_URL,
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        alert('Skripsi berhasil diupload!');
                        $('#uploadForm')[0].reset();
                    } else {
                        alert('Gagal upload skripsi: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error upload skripsi: ' + error);
                }
            });
        }
        
        // Fungsi untuk memuat visualisasi data
        function loadVisualisasiData() {
            // Data contoh untuk chart
            const prodiData = {
                'Ekonomi Syariah': 45,
                'Perbankan Syariah': 32,
                'Manajemen Bisnis Syariah': 28
            };
            
            const statusData = {
                'Selesai': 60,
                'Dalam Proses': 35,
                'Tertunda': 15
            };
            
            // Chart untuk program studi
            const prodiCtx = document.getElementById('prodiChart').getContext('2d');
            prodiChart = new Chart(prodiCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(prodiData),
                    datasets: [{
                        label: 'Jumlah Mahasiswa',
                        data: Object.values(prodiData),
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(155, 89, 182, 0.7)'
                        ],
                        borderColor: [
                            'rgba(52, 152, 219, 1)',
                            'rgba(46, 204, 113, 1)',
                            'rgba(155, 89, 182, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Chart untuk status
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusData),
                    datasets: [{
                        data: Object.values(statusData),
                        backgroundColor: [
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(241, 196, 15, 0.7)',
                            'rgba(231, 76, 60, 0.7)'
                        ],
                        borderColor: [
                            'rgba(46, 204, 113, 1)',
                            'rgba(241, 196, 15, 1)',
                            'rgba(231, 76, 60, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Helper function untuk mendapatkan warna badge berdasarkan status
        function getStatusBadgeColor(status) {
            switch(status) {
                case 'Selesai': return 'success';
                case 'Dalam Proses': return 'warning';
                case 'Tertunda': return 'danger';
                default: return 'secondary';
            }
        }
    </script>
</body>
</html>
