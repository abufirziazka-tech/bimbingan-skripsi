<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIBIS Sistem Informasi dan Bimbingan Skripsi</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* CSS yang sudah ada dipertahankan */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --success-color: #27ae60;
            --warning-color: #f39c12;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        /* CSS lainnya tetap sama */
        /* ... */
    </style>
</head>
<body>
    <div class="d-flex" id="wrapper">
        <!-- Sidebar (tetap sama) -->
        <!-- ... -->

        <!-- Page Content -->
        <div id="content">
            <div class="container-fluid">
                <!-- Main Dashboard Stats (tetap sama) -->
                <!-- ... -->
                
                <!-- Skripsi Section -->
                <div id="skripsiContent" style="display: none;">
                    <!-- Database Skripsi -->
                    <div class="content-section" id="databaseSkripsi">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Database Skripsi</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label for="filterTahun" class="form-label">Tahun Lulus</label>
                                        <select class="form-select" id="filterTahun">
                                            <option value="">Semua Tahun</option>
                                            <!-- Options will be populated by JavaScript -->
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="filterProdi" class="form-label">Program Studi</label>
                                        <select class="form-select" id="filterProdi">
                                            <option value="">Semua Program Studi</option>
                                            <option value="ES">Ekonomi Syariah</option>
                                            <option value="PS">Perbankan Syariah</option>
                                            <option value="MBS">Manajemen Bisnis Syariah</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="filterStatus" class="form-label">Status</label>
                                        <select class="form-select" id="filterStatus">
                                            <option value="">Semua Status</option>
                                            <option value="Lulus">Lulus</option>
                                            <option value="Proses">Dalam Proses</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="searchJudul" class="form-label">Pencarian Judul</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="searchJudul" placeholder="Cari judul...">
                                            <button class="btn btn-primary" type="button" id="btnSearch">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover" id="tableSkripsi">
                                        <thead>
                                            <tr>
                                                <th>Judul</th>
                                                <th>Penulis</th>
                                                <th>Tahun</th>
                                                <th>Prodi</th>
                                                <th>Pembimbing 1</th>
                                                <th>Pembimbing 2</th>
                                                <th>Status</th>
                                                <th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Data will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upload Skripsi Final (tetap sama) -->
                    <!-- ... -->
                </div>
                
                <!-- Statistik Section (tetap sama) -->
                <!-- ... -->
            </div>
        </div>
    </div>

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Google Apps Script Web App URL
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbzW6KfGb7BPuL0ram9H1PAhzRDPtC70fQWAUzJe54vauZmKlxJmKGS2xz0ZDV_xiIVO/exec';
        
        // Global variables
        let currentSection = 'pengajuan';
        let currentMenu = 'bimbingan';
        let bimbinganData = [];
        let skripsiData = [];
        let earlyWarningData = [];
        
        // Initialize dashboard
        $(document).ready(function() {
            // Initialize sidebar menu
            initSidebarMenu();
            
            // Load initial data
            loadInitialData();
            
            // Initialize tahun akademik options
            initTahunAkademik();
            
            // Initialize dosen options
            initDosenOptions();
            
            // Initialize charts
            initCharts();
            
            // Add click events to main stat cards
            $('.main-stat-card').click(function() {
                const target = $(this).data('target');
                
                if (target === 'databaseSkripsi') {
                    // Open Skripsi menu and show database
                    $('#skripsiSubmenu').collapse('show');
                    setTimeout(function() {
                        $('#skripsiContent').show();
                        $('#bimbinganContent, #statistikContent').hide();
                        $('a[href="#databaseSkripsi"]').click();
                    }, 300);
                } else {
                    // Open Bimbingan menu and show target section
                    $('#bimbinganSubmenu').collapse('show');
                    setTimeout(function() {
                        $('#bimbinganContent').show();
                        $('#skripsiContent, #statistikContent').hide();
                        $(`a[href="#${target}"]`).click();
                    }, 300);
                }
            });

            // Add event listener for NIM input to autofill data
            $('#nimSkripsi').on('input', function() {
                const nim = $(this).val().trim();
                if (nim.length > 0) {
                    // Find the student data by NIM in bimbinganData
                    const studentData = bimbinganData.find(item => item.NIM === nim);
                    if (studentData) {
                        // If found, autofill and disable fields
                        $('#namaSkripsi').val(studentData.Nama).prop('readonly', true);
                        $('#prodiSkripsi').val(studentData.Prodi).prop('disabled', true);
                        $('#judulSkripsiFinal').val(studentData.Judul);
                    } else {
                        // If not found, enable fields and clear
                        $('#namaSkripsi').val('').prop('readonly', false);
                        $('#prodiSkripsi').val('').prop('disabled', false);
                        $('#judulSkripsiFinal').val('');
                    }
                } else {
                    $('#namaSkripsi').val('').prop('readonly', false);
                    $('#prodiSkripsi').val('').prop('disabled', false);
                    $('#judulSkripsiFinal').val('');
                }
            });

            // Event handler untuk form pengajuan proposal
            $('#pengajuanProposalForm').submit(function(e) {
                e.preventDefault();
                
                // Basic validation
                const nim = $('#nimProposal').val();
                const nama = $('#namaProposal').val();
                const prodi = $('#prodiProposal').val();
                const tahunAkademik = $('#tahunAkademik').val();
                const judul = $('#judulProposal').val();
                const dosenPembimbing1 = $('#dosenPembimbing1').val();
                const dosenPembimbing2 = $('#dosenPembimbing2').val();
                const fileInput = $('#fileProposal')[0];
                
                if (!nim || !nama || !prodi || !tahunAkademik || !judul || !dosenPembimbing1 || !fileInput.files[0]) {
                    alert('Harap lengkapi semua field yang wajib diisi');
                    return;
                }
                
                const file = fileInput.files[0];
                
                // Show loading
                const submitBtn = $(this).find('button[type="submit"]');
                const originalText = submitBtn.html();
                submitBtn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Mengajukan...');
                submitBtn.prop('disabled', true);
                
                // Convert file to base64
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function() {
                    const base64 = reader.result.split(',')[1];
                    
                    // Prepare data for submission
                    const formData = new FormData();
                    formData.append('action', 'uploadProposal');
                    formData.append('nim', nim);
                    formData.append('nama', nama);
                    formData.append('prodi', prodi);
                    formData.append('tahunAkademik', tahunAkademik);
                    formData.append('judul', judul);
                    formData.append('dosenPembimbing1', dosenPembimbing1);
                    formData.append('dosenPembimbing2', dosenPembimbing2 || '');
                    formData.append('filename', file.name);
                    formData.append('mimeType', file.type);
                    formData.append('file', base64);
                    
                    // Send data to Google Apps Script
                    fetch(scriptUrl, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.result === 'success') {
                            alert('Proposal berhasil diajukan!');
                            $('#pengajuanProposalForm')[0].reset();
                            
                            // Reload data to reflect changes
                            loadInitialData();
                        } else {
                            alert('Terjadi kesalahan: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Terjadi kesalahan saat mengajukan proposal.');
                    })
                    .finally(() => {
                        // Restore button
                        submitBtn.html(originalText);
                        submitBtn.prop('disabled', false);
                    });
                };
                
                reader.onerror = function(error) {
                    console.error('Error reading file:', error);
                    alert('Terjadi kesalahan saat membaca file.');
                    submitBtn.html(originalText);
                    submitBtn.prop('disabled', false);
                };
            });
        });
        
        // Initialize sidebar menu functionality
        function initSidebarMenu() {
            // Main menu click event
            $('.main-item').click(function(e) {
                e.preventDefault();
                
                const target = $(this).attr('href');
                
                // Hide all content sections
                $('#bimbinganContent, #skripsiContent, #statistikContent').hide();
                
                // Show target content
                if (target === '#statistik') {
                    $('#statistikContent').show();
                    currentMenu = 'statistik';
                    loadStatistikData();
                }
                
                // Update active menu
                $('.main-item').removeClass('active');
                $(this).addClass('active');
            });
            
            // Submenu click event for Bimbingan
            $('.sub-item').click(function(e) {
                e.preventDefault();
                
                const target = $(this).attr('href');
                
                // Hide all content sections in Bimbingan
                $('#bimbinganContent .content-section').hide();
                
                // Show target content
                $(target).show();
                currentSection = target.substring(1);
                
                // Load data if needed
                if (currentSection === 'dataBimbingan') {
                    loadBimbinganData();
                } else if (currentSection === 'tahapBimbingan') {
                    loadTahapBimbingan();
                } else if (currentSection === 'statusBimbingan') {
                    loadStatusBimbingan();
                } else if (currentSection === 'earlyWarning') {
                    loadEarlyWarning();
                }
                
                // Update active submenu
                $('.sub-item').removeClass('active');
                $(this).addClass('active');
            });
            
            // Bimbingan menu toggle
            $('#bimbinganSubmenu').on('show.bs.collapse', function() {
                currentMenu = 'bimbingan';
                $('#bimbinganContent').show();
                $('#skripsiContent, #statistikContent').hide();
                
                // Update active menu
                $('.main-item').removeClass('active');
                $('a[href="#bimbinganSubmenu"]').addClass('active');
            });
            
            // Skripsi menu toggle
            $('#skripsiSubmenu').on('show.bs.collapse', function() {
                currentMenu = 'skripsi';
                $('#skripsiContent').show();
                $('#bimbinganContent, #statistikContent').hide();
                
                // Update active menu
                $('.main-item').removeClass('active');
                $('a[href="#skripsiSubmenu"]').addClass('active');
                
                // Load data if needed
                loadSkripsiData();
            });
            
            // Submenu click event for Skripsi
            $('#skripsiSubmenu .sub-item').click(function(e) {
                e.preventDefault();
                
                const target = $(this).attr('href');
                
                // Hide all content sections in Skripsi
                $('#skripsiContent .content-section').hide();
                
                // Show target content
                $(target).show();
                
                // Load data if needed
                if (target === '#databaseSkripsi') {
                    loadSkripsiData();
                }
                
                // Update active submenu
                $('#skripsiSubmenu .sub-item').removeClass('active');
                $(this).addClass('active');
            });
        }
        
        // Load initial data
        function loadInitialData() {
            // Show loading state
            showLoading();
            
            // Load bimbingan data
            $.ajax({
                url: scriptUrl,
                method: 'GET',
                dataType: 'json',
                data: {
                    action: 'getBimbingan'
                },
                success: function(response) {
                    bimbinganData = response;
                    loadBimbinganData();
                    updateMainStats(); // Update main dashboard stats
                },
                error: function(error) {
                    console.error('Error loading bimbingan data:', error);
                    hideLoading();
                }
            });
            
            // Load skripsi data
            $.ajax({
                url: scriptUrl,
                method: 'GET',
                dataType: 'json',
                data: {
                    action: 'getSkripsi'
                },
                success: function(response) {
                    skripsiData = response;
                    updateMainStats(); // Update main dashboard stats
                },
                error: function(error) {
                    console.error('Error loading skripsi data:', error);
                }
            });
            
            // Load early warning data
            $.ajax({
                url: scriptUrl,
                method: 'GET',
                dataType: 'json',
                data: {
                    action: 'getEarlyWarning'
                },
                success: function(response) {
                    earlyWarningData = response;
                    updateMainStats(); // Update main dashboard stats
                },
                error: function(error) {
                    console.error('Error loading early warning data:', error);
                }
            });
            
            // Load skripsi final data
            $.ajax({
                url: scriptUrl,
                method: 'GET',
                dataType: 'json',
                data: {
                    action: 'getSkripsiFinal'
                },
                success: function(response) {
                    // Data loaded, but not stored globally as not needed elsewhere
                    updateMainStats(); // Update main dashboard stats
                },
                error: function(error) {
                    console.error('Error loading skripsi final data:', error);
                }
            });
        }
        
        // Update main dashboard statistics
        function updateMainStats() {
            // Update total skripsi
            $('#totalSkripsiMain').text(skripsiData.length);
            
            // Update total bimbingan
            $('#totalBimbinganMain').text(bimbinganData.length);
            
            // Update selesai bimbingan
            const selesaiCount = bimbinganData.filter(item => item.Status === 'Selesai').length;
            $('#selesaiBimbinganMain').text(selesaiCount);
            
            // Update early warning
            $('#earlyWarningMain').text(earlyWarningData.length);
        }
        
        // Initialize tahun akademik options
        function initTahunAkademik() {
            const currentYear = new Date().getFullYear();
            const selectElement = $('#tahunAkademik');
            
            // Clear existing options
            selectElement.empty();
            selectElement.append('<option value="">Pilih Tahun Akademik</option>');
            
            // Add options for the last 5 years and current year
            for (let i = 4; i >= 0; i--) {
                const year = currentYear - i;
                const academicYear = year + '/' + (year + 1);
                selectElement.append(`<option value="${academicYear}">${academicYear}</option>`);
            }
            
            // Also initialize for tahun lulus
            $('#tahunLulus').empty();
            $('#tahunLulus').append('<option value="">Pilih Tahun Lulus</option>');
            $('#filterTahun').empty();
            $('#filterTahun').append('<option value="">Semua Tahun</option>');
            
            for (let i = 4; i >= 0; i--) {
                const year = currentYear - i;
                $('#tahunLulus').append(`<option value="${year}">${year}</option>`);
                $('#filterTahun').append(`<option value="${year}">${year}</option>`);
            }
        }
        
        // Initialize dosen options
        function initDosenOptions() {
            // In a real application, this would come from a database
            const dosenList = [
                {id: 1, nama: "Dr. Ahmad Susanto, M.Si"},
                {id: 2, nama: "Prof. Dr. Siti Aminah, M.Ag"},
                {id: 3, nama: "Dr. Muhammad Rizal, S.E., M.Si"},
                {id: 4, nama: "Dr. Fatimah Zahra, M.E.I"},
                {id: 5, nama: "Dr. Abdul Rahman, S.E.I., M.Si"}
            ];
            
            const selectPembimbing1 = $('#dosenPembimbing1');
            const selectPembimbing2 = $('#dosenPembimbing2');
            
            // Clear existing options
            selectPembimbing1.empty();
            selectPembimbing2.empty();
            
            // Add default options
            selectPembimbing1.append('<option value="">Pilih Dosen Pembimbing 1</option>');
            selectPembimbing2.append('<option value="">Pilih Dosen Pembimbing 2 (jika diperlukan)</option>');
            
            // Add dosen options
            dosenList.forEach(dosen => {
                selectPembimbing1.append(`<option value="${dosen.id}">${dosen.nama}</option>`);
                selectPembimbing2.append(`<option value="${dosen.id}">${dosen.nama}</option>`);
            });
        }
        
        // Load bimbingan data to table
        function loadBimbinganData() {
            const tableBody = $('#tableBimbingan tbody');
            tableBody.empty();
            
            if (bimbinganData.length === 0) {
                tableBody.append('<tr><td colspan="8" class="text-center">Tidak ada data bimbingan</td></tr>');
                return;
            }
            
            bimbinganData.forEach(item => {
                const statusClass = getStatusClass(item.Status);
                
                const row = `
                    <tr>
                        <td>${item.NIM || ''}</td>
                        <td>${item.Nama || ''}</td>
                        <td>${getProdiName(item.Prodi) || ''}</td>
                        <td>${item.Pembimbing1 || ''}</td>
                        <td>${item.Pembimbing2 || ''}</td>
                        <td>${item.Judul || ''}</td>
                        <td><span class="badge ${statusClass}">${item.Status || ''}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning"><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>
                `;
                
                tableBody.append(row);
            });
            
            hideLoading();
        }
        
        // Load tahap bimbingan data
        function loadTahapBimbingan() {
            const tableBody = $('#tableTahapBimbingan tbody');
            tableBody.empty();
            
            if (bimbinganData.length === 0) {
                tableBody.append('<tr><td colspan="6" class="text-center">Tidak ada data tahap bimbingan</td></tr>');
                return;
            }
            
            bimbinganData.forEach(item => {
                const progress = Math.min(100, Math.floor(Math.random() * 100));
                
                const row = `
                    <tr>
                        <td>${item.NIM || ''}</td>
                        <td>${item.Nama || ''}</td>
                        <td>${getTahapBimbingan(progress)}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: ${progress}%;">${progress}%</div>
                            </div>
                        </td>
                        <td>${new Date().toLocaleDateString('id-ID')}</td>
                        <td>
                            <button class="btn btn-sm btn-info"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-success"><i class="fas fa-check"></i></button>
                        </td>
                    </tr>
                `;
                
                tableBody.append(row);
            });
        }
        
        // Load status bimbingan data
        function loadStatusBimbingan() {
            const tableBody = $('#tableStatusBimbingan tbody');
            tableBody.empty();
            
            // Update stat cards
            $('#totalBimbingan').text(bimbinganData.length);
            $('#selesaiBimbingan').text(bimbinganData.filter(item => item.Status === 'Selesai').length);
            $('#prosesBimbingan').text(bimbinganData.filter(item => item.Status === 'Dalam Proses').length);
            $('#terlambatBimbingan').text(bimbinganData.filter(item => item.Status === 'Terlambat').length);
            
            if (bimbinganData.length === 0) {
                tableBody.append('<tr><td colspan="7" class="text-center">Tidak ada data status bimbingan</td></tr>');
                return;
            }
            
            bimbinganData.forEach(item => {
                const progress = Math.min(100, Math.floor(Math.random() * 100));
                const statusClass = getStatusClass(item.Status);
                const estSelesai = new Date();
                estSelesai.setDate(estSelesai.getDate() + Math.floor(Math.random() * 90));
                
                const row = `
                    <tr>
                        <td>${item.NIM || ''}</td>
                        <td>${item.Nama || ''}</td>
                        <td>${getProdiName(item.Prodi) || ''}</td>
                        <td>${item.Judul || ''}</td>
                        <td><span class="badge ${statusClass}">${item.Status || ''}</span></td>
                        <td>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar" role="progressbar" style="width: ${progress}%;"></div>
                            </div>
                        </td>
                        <td>${estSelesai.toLocaleDateString('id-ID')}</td>
                    </tr>
                `;
                
                tableBody.append(row);
            });
        }
        
        // Load early warning data
        function loadEarlyWarning() {
            const tableBody = $('#tableEarlyWarning tbody');
            tableBody.empty();
            
            if (earlyWarningData.length === 0) {
                tableBody.append('<tr><td colspan="7" class="text-center">Tidak ada data early warning</td></tr>');
                return;
            }
            
            earlyWarningData.forEach(item => {
                const semester = calculateSemester(item.NIM);
                const statusClass = getStatusClass(item.Status);
                const warningLevel = getWarningLevel(semester);
                
                const row = `
                    <tr>
                        <td>${item.NIM || ''}</td>
                        <td>${item.Nama || ''}</td>
                        <td>${getProdiName(item.Prodi) || ''}</td>
                        <td>${semester}</td>
                        <td><span class="badge ${statusClass}">${item.Status || ''}</span></td>
                        <td><span class="badge bg-danger">${warningLevel}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning"><i class="fas fa-bell"></i> Notifikasi</button>
                        </td>
                    </tr>
                `;
                
                tableBody.append(row);
            });
        }
        
        // Load skripsi data - FUNGSI YANG DIPERBAIKI
        function loadSkripsiData() {
            const tableBody = $('#tableSkripsi tbody');
            tableBody.empty();
            
            if (skripsiData.length === 0) {
                tableBody.append('<tr><td colspan="8" class="text-center">Tidak ada data skripsi</td></tr>');
                return;
            }
            
            skripsiData.forEach(item => {
                const statusClass = item.Status === 'Lulus' ? 'bg-success' : 'bg-warning';
                
                const row = `
                    <tr>
                        <td>${item.Judul || ''}</td>
                        <td>${item.Penulis || ''}</td>
                        <td>${item.Tahun || ''}</td>
                        <td>${getProdiName(item.Prodi) || ''}</td>
                        <td>${item.Pembimbing1 || ''}</td>
                        <td>${item.Pembimbing2 || ''}</td>
                        <td><span class="badge ${statusClass}">${item.Status || ''}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-primary"><i class="fas fa-download"></i></button>
                        </td>
                    </tr>
                `;
                
                tableBody.append(row);
            });
        }
        
        // Load statistik data
        function loadStatistikData() {
            // In a real application, this would come from the server
            updateProdiChart();
            updateStatusChart();
            updateWaktuChart();
            updateTrendChart();
        }
        
        // Initialize charts
        function initCharts() {
            // Charts will be initialized when statistik section is loaded
        }
        
        // Update prodi chart
        function updateProdiChart() {
            const ctx = document.getElementById('prodiChart').getContext('2d');
            
            // Sample data
            const data = {
                labels: ['Ekonomi Syariah', 'Perbankan Syariah', 'Manajemen Bisnis Syariah'],
                datasets: [{
                    label: 'Jumlah Bimbingan',
                    data: [25, 18, 22],
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(155, 89, 182, 0.7)'
                    ],
                    borderColor: [
                        'rgb(52, 152, 219)',
                        'rgb(46, 204, 113)',
                        'rgb(155, 89, 182)'
                    ],
                    borderWidth: 1
                }]
            };
            
            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Jumlah Bimbingan per Program Studi'
                        }
                    }
                },
            };
            
            new Chart(ctx, config);
        }
        
        // Update status chart
        function updateStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            // Sample data
            const data = {
                labels: ['Selesai', 'Dalam Proses', 'Terlambat'],
                datasets: [{
                    data: [35, 45, 20],
                    backgroundColor: [
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(231, 76, 60, 0.7)'
                    ],
                    borderColor: [
                        'rgb(46, 204, 113)',
                        'rgb(52, 152, 219)',
                        'rgb(231, 76, 60)'
                    ],
                    borderWidth: 1
                }]
            };
            
            const config = {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Status Penyelesaian Skripsi'
                        }
                    }
                },
            };
            
            new Chart(ctx, config);
        }
        
        // Update waktu chart
        function updateWaktuChart() {
            const ctx = document.getElementById('waktuChart').getContext('2d');
            
            // Sample data
            const data = {
                labels: ['Ekonomi Syariah', 'Perbankan Syariah', 'Manajemen Bisnis Syariah'],
                datasets: [{
                    label: 'Rata-rata Waktu (bulan)',
                    data: [6.2, 5.8, 6.5],
                    backgroundColor: 'rgba(241, 196, 15, 0.7)',
                    borderColor: 'rgb(241, 196, 15)',
                    borderWidth: 1
                }]
            };
            
            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Rata-rata Waktu Penyelesaian Skripsi (bulan)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                },
            };
            
            new Chart(ctx, config);
        }
        
        // Update trend chart
        function updateTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // Sample data
            const data = {
                labels: ['2018', '2019', '2020', '2021', '2022'],
                datasets: [{
                    label: 'Jumlah Skripsi',
                    data: [15, 22, 30, 35, 42],
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            };
            
            const config = {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Trend Jumlah Skripsi per Tahun'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                },
            };
            
            new Chart(ctx, config);
        }
        
        // Handle skripsi upload form submission
        $('#uploadSkripsiForm').submit(function(e) {
            e.preventDefault();
            
            // Basic validation
            const nim = $('#nimSkripsi').val();
            const nama = $('#namaSkripsi').val();
            const prodi = $('#prodiSkripsi').val();
            const judul = $('#judulSkripsiFinal').val();
            const tahunLulus = $('#tahunLulus').val();
            const tanggalSidang = $('#tanggalSidang').val();
            const fileInput = $('#fileSkripsi')[0];
            const approval = $('#approvalCheck').is(':checked');
            
            if (!nim || !nama || !prodi || !judul || !tahunLulus || !tanggalSidang || !fileInput.files[0] || !approval) {
                alert('Harap lengkapi semua field dan centang persetujuan');
                return;
            }
            
            const file = fileInput.files[0];
            
            // Show loading
            const submitBtn = $(this).find('button[type="submit"]');
            const originalText = submitBtn.html();
            submitBtn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Mengupload...');
            submitBtn.prop('disabled', true);
            
            // Convert file to base64
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function() {
                const base64 = reader.result.split(',')[1];
                
                // Prepare data for submission
                const formData = new FormData();
                formData.append('action', 'uploadSkripsiFinal');
                formData.append('nim', nim);
                formData.append('nama', nama);
                formData.append('prodi', prodi);
                formData.append('judul', judul);
                formData.append('tahunLulus', tahunLulus);
                formData.append('tanggalSidang', tanggalSidang);
                formData.append('filename', file.name);
                formData.append('mimeType', file.type);
                formData.append('file', base64);
                
                // Send data to Google Apps Script
                fetch(scriptUrl, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        alert('Skripsi final berhasil diupload!');
                        $('#uploadSkripsiForm')[0].reset();
                        
                        // Reload data to reflect changes
                        loadInitialData();
                    } else {
                        alert('Terjadi kesalahan: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Terjadi kesalahan saat mengupload skripsi final.');
                })
                .finally(() => {
                    // Restore button
                    submitBtn.html(originalText);
                    submitBtn.prop('disabled', false);
                });
            };
            
            reader.onerror = function(error) {
                console.error('Error reading file:', error);
                alert('Terjadi kesalahan saat membaca file.');
                submitBtn.html(originalText);
                submitBtn.prop('disabled', false);
            };
        });
        
        // Filter skripsi table
        $('#filterTahun, #filterProdi, #filterStatus, #btnSearch').change(function() {
            // In a real application, this would filter the data from server
            // For now, we'll just show a message
            console.log('Filtering data...');
        });
        
        // Helper function to get status class for badges
        function getStatusClass(status) {
            switch(status) {
                case 'Selesai': return 'bg-success';
                case 'Dalam Proses': return 'bg-primary';
                case 'Terlambat': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
        
        // Helper function to get prodi name from code
        function getProdiName(code) {
            switch(code) {
                case 'ES': return 'Ekonomi Syariah';
                case 'PS': return 'Perbankan Syariah';
                case 'MBS': return 'Manajemen Bisnis Syariah';
                default: return code;
            }
        }
        
        // Helper function to calculate semester based on NIM
        function calculateSemester(nim) {
            if (!nim) return 0;
            
            // Extract year from NIM (assuming first two digits represent admission year)
            const admissionYear = parseInt('20' + nim.substring(0, 2));
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            
            // Calculate approximate semester (2 semesters per year)
            let semester = (currentYear - admissionYear) * 2;
            
            // Adjust for current month (if after June, add one semester)
            if (currentMonth >= 6) semester += 1;
            
            return semester;
        }
        
        // Helper function to get warning level based on semester
        function getWarningLevel(semester) {
            if (semester >= 13) return 'SANGAT TINGGI';
            if (semester >= 11) return 'TINGGI';
            if (semester >= 9) return 'SEDANG';
            return 'RENDAH';
        }
        
        // Helper function to get tahap bimbingan based on progress
        function getTahapBimbingan(progress) {
            if (progress >= 75) return 'Bimbingan Skripsi';
            if (progress >= 50) return 'Seminar Hasil';
            if (progress >= 25) return 'Bimbingan Proposal';
            return 'Pengajuan Judul';
        }
        
        // Show loading state
        function showLoading() {
            $('#tableBimbingan tbody').html('<tr><td colspan="8" class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>');
        }
        
        // Hide loading state
        function hideLoading() {
            // Loading state will be replaced with actual data
        }
    </script>
</body>
</html>
